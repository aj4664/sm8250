name: Build Kernel
permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      target_device:
        description: 'ç›®æ ‡è®¾å¤‡ (Target Device) [Allæš‚ä¸å¯ç”¨]'
        required: true
        default: 'umi'
        type: choice
        options: ['umi', 'cmi', 'cas', 'thyme', 'munch', 'dagu', 'elish', 'enuma', 'alioth', 'apollo', 'lmi', 'psyche', 'pipa', 'All']

      compiled_system:
        description: 'é€‚ç”¨ç³»ç»Ÿ (Compiled System) [Allæš‚ä¸å¯ç”¨]'
        required: true
        type: choice
        default: 'MIUI'
        options: ['MIUI', 'AOSP', 'All']
        
      kernelsu_variant:
        description: 'KernelSU å˜ä½“ (KernelSU Variant)'
        required: true
        type: choice
        default: 'SukiSU-Ultra'
        options: ['SukiSU-Ultra', 'RKSU', 'KernelSU', 'None']

      build_type:
        description: 'å†…æ ¸æ„å»ºç±»å‹ (Build Type)'
        required: true
        type: choice
        default: 'Release'
        options: ['Release', 'Dev']

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      KERNEL_ROOT: "/home/runner/work/kernel_xiaomi_sm8250_mod/kernel_xiaomi_sm8250_mod"
      KERNEL_IMAGE: "/home/runner/work/kernel_xiaomi_sm8250_mod/kernel_xiaomi_sm8250_mod/kernel_platform/out/arch/arm64/boot/Image"
      KERNEL_DTBO: "/home/runner/work/kernel_xiaomi_sm8250_mod/kernel_xiaomi_sm8250_mod/kernel_platform/out/arch/arm64/boot/dtbo.img"
      KERNEL_DTB: "/home/runner/work/kernel_xiaomi_sm8250_mod/kernel_xiaomi_sm8250_mod/kernel_platform/out/arch/arm64/boot/dtb.img"
    steps:
      - name: æœ€å¤§åŒ–æ„å»ºç©ºé—´
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          swap-size-mb: 8192
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"
          remove-codeql: "true"
          
      - name: å…‹éš†å†…æ ¸æºç 
        id: clone
        continue-on-error: true
        run: |
          git clone https://github.com/yspbwx2010/kernel_xiaomi_sm8250_mod.git --depth=1 kernel_platform
          
      - name: æ£€æŸ¥æºç å…‹éš†çŠ¶æ€
        if: steps.clone.outcome == 'failure'
        run: |
          echo "âŒ å†…æ ¸æºç å…‹éš†å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»“åº“åœ°å€æ˜¯å¦æ­£ç¡®"
          exit 1
          
      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt update
          sudo apt install -y bc binutils-dev bison build-essential ccache clang cmake curl file flex gcc git libelf-dev libncurses-dev libssl-dev lld llvm make ninja-build python3 python3-dev python3-pip texinfo tree u-boot-tools wget xz-utils zip zlib1g-dev

      - name: é…ç½® ccache
        run: |
          mkdir -p ~/.cache/ccache
          ccache --max-size=2G
          ccache --set-config=compression=true
          echo "CCACHE_DIR=$HOME/.cache/ccache" >> $GITHUB_ENV
          
      - name: ä»ç¼“å­˜æ¢å¤ ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ccache-${{ github.event.inputs.target_device }}-${{ github.event.inputs.compiled_system }}
          restore-keys: ccache-${{ github.event.inputs.target_device }}-
            
      - name: ç¼“å­˜å·¥å…·é“¾
        id: cache-toolchain
        uses: actions/cache@v4
        with:
          path: ${{ env.KERNEL_ROOT }}/kernel_platform/toolchain
          key: toolchain-clang-r547379-gcc
            
      - name: ä¸‹è½½å·¥å…·é“¾
        if: steps.cache-toolchain.outputs.cache-hit != 'true'
        run: |
          cd "$KERNEL_ROOT/kernel_platform"
          mkdir -p toolchain/clang
          cd toolchain/clang
          wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r547379.tar.gz -O clang-r547379.tar.gz || { echo "âŒ å·¥å…·é“¾ä¸‹è½½å¤±è´¥"; exit 1; }
          tar -xf clang-r547379.tar.gz || { echo "âŒ å·¥å…·é“¾è§£å‹å¤±è´¥"; exit 1; }
          rm clang-r547379.tar.gz
          git submodule update --init --remote toolchain/gcc/gcc64 || { echo "âŒ GCC64 å·¥å…·é“¾åŒæ­¥å¤±è´¥"; exit 1; }
          git submodule update --init --remote toolchain/gcc/gcc32 || { echo "âŒ GCC32 å·¥å…·é“¾åŒæ­¥å¤±è´¥"; exit 1; }

      - name: é…ç½® KernelSU
        run: |
          cd "$KERNEL_ROOT/kernel_platform"
          KSU_VARIANT="${{ github.event.inputs.kernelsu_variant }}"
          
          case "$KSU_VARIANT" in
            "SukiSU-Ultra")
              curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/susfs-dev/kernel/setup.sh" | bash -s susfs-dev || { echo "âŒ SukiSU-Ultra é…ç½®å¤±è´¥"; exit 1; }
              ;;
            "RKSU")
              curl -LSs "https://raw.githubusercontent.com/rsuntk/KernelSU/susfs-v1.5.5/kernel/setup.sh" | bash -s susfs-v1.5.5 || { echo "âŒ RKSU é…ç½®å¤±è´¥"; exit 1; }
              ;;
            "KernelSU")
              curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s v0.9.5 || { echo "âŒ KernelSU é…ç½®å¤±è´¥"; exit 1; }
              ;;
          esac
          
      - name: æ„å»ºå†…æ ¸
        run: |
          cd "$KERNEL_ROOT/kernel_platform"
          
          DEVICE="${{ github.event.inputs.target_device }}"
          SYSTEM="${{ github.event.inputs.compiled_system }}"
          KSU="${{ github.event.inputs.kernelsu_variant }}"
          
          [[ "$DEVICE" == "All" || "$SYSTEM" == "All" ]] && { echo "âŒ ä¸æ”¯æŒ All é€‰é¡¹"; exit 1; }
          
          export CCACHE=1
          export PATH="/usr/bin:$PATH"
          
          MAKE_ARGS="ARCH=arm64 SUBARCH=arm64 LLVM=1 LLVM_IAS=1 \
            CROSS_COMPILE=./toolchain/gcc/gcc64/aarch64-linux-android- \
            CROSS_COMPILE_COMPAT=./toolchain/gcc/gcc32/arm-linux-androideabi- \
            CROSS_COMPILE_ARM32=./toolchain/gcc/gcc32/arm-linux-androideabi- \
            CLANG_TRIPLE=aarch64-linux-gnu- CC=clang CXX=clang++ \
            HOSTCC=clang HOSTCXX=clang++ LD=ld.lld HOSTLD=ld.lld \
            KCFLAGS=-Wno-error O=out"

          echo "ğŸ“ ç”Ÿæˆè®¾å¤‡é…ç½®..."
          make $MAKE_ARGS -j$(nproc --all) ${DEVICE}_defconfig || { echo "âŒ è®¾å¤‡é…ç½®ç”Ÿæˆå¤±è´¥"; exit 1; }

          if [ "$SYSTEM" == "MIUI" ]; then
            echo "ğŸ“ åº”ç”¨ MIUI é…ç½®..."
            scripts/config --file out/.config \
              --set-str STATIC_USERMODEHELPER_PATH /system/bin/micd \
              -e PERF_CRITICAL_RT_TASK -e SF_BINDER -e OVERLAY_FS -d DEBUG_FS \
              -e MIGT -e MIGT_ENERGY_MODEL -e MIHW -e PACKAGE_RUNTIME_INFO \
              -e BINDER_OPT -e KPERFEVENTS -e MILLET -e PERF_HUMANTASK \
              -d LTO_CLANG -d LOCALVERSION_AUTO -e SF_BINDER -e XIAOMI_MIUI \
              -d MI_MEMORY_SYSFS -e TASK_DELAY_ACCT -e MIUI_ZRAM_MEMORY_TRACKING \
              -d CONFIG_MODULE_SIG_SHA512 -d CONFIG_MODULE_SIG_HASH \
              -e MI_FRAGMENTION -e PERF_HELPER -e BOOTUP_RECLAIM \
              -e MI_RECLAIM -e RTMM || { echo "âŒ MIUI é…ç½®åº”ç”¨å¤±è´¥"; exit 1; }
          fi

          if [ "$KSU" == "SukiSU-Ultra" ] || [ "$KSU" == "RKSU" ]; then
            echo "ğŸ“ åº”ç”¨ KernelSU é…ç½®..."
            scripts/config --file out/.config \
              -e KSU -e KSU_SUSFS -e KSU_SUSFS_HAS_MAGIC_MOUNT \
              -e KSU_SUSFS_SUS_PATH -e KSU_SUSFS_SUS_MOUNT \
              -e KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT \
              -e KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT -e KSU_SUSFS_SUS_KSTAT \
              -d KSU_SUSFS_SUS_OVERLAYFS -e KSU_SUSFS_TRY_UMOUNT \
              -e KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT \
              -e KSU_SUSFS_SPOOF_UNAME -e KSU_SUSFS_ENABLE_LOG \
              -e KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS \
              -e KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG \
              -e KSU_SUSFS_OPEN_REDIRECT -d KSU_SUSFS_SUS_SU || { echo "âŒ KernelSU é…ç½®åº”ç”¨å¤±è´¥"; exit 1; }
            [ "$KSU" == "SukiSU-Ultra" ] && scripts/config --file out/.config -e KPM
          elif [ "$KSU" == "KernelSU" ]; then
            scripts/config --file out/.config -e KSU || { echo "âŒ KernelSU é…ç½®åº”ç”¨å¤±è´¥"; exit 1; }
          fi

          echo "ğŸ”¨ å¼€å§‹æ„å»ºå†…æ ¸..."
          make $MAKE_ARGS -j$(nproc --all) || { echo "âŒ å†…æ ¸æ„å»ºå¤±è´¥"; exit 1; }
          
          # æ£€æŸ¥å¿…è¦æ–‡ä»¶
          for file in "$KERNEL_IMAGE" "$KERNEL_DTBO" "$KERNEL_DTB"; do
            if [ ! -f "$file" ]; then
              echo "âŒ æ‰¾ä¸åˆ°æ–‡ä»¶: $file"
              exit 1
            fi
          done
          
          echo "âœ… å†…æ ¸æ„å»ºæˆåŠŸ"
          echo "ğŸ“Š æ„å»ºç»Ÿè®¡ä¿¡æ¯:"
          ccache --show-stats

      - name: KPM ä¿®è¡¥
        if: github.event.inputs.kernelsu_variant == 'SukiSU-Ultra'
        run: |
          cd "$KERNEL_ROOT/kernel_platform/out/arch/arm64/boot"
          echo "ğŸ“ ä¸‹è½½ KPM ä¿®è¡¥å·¥å…·..."
          curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU_patch/refs/heads/main/kpm/patch_linux" -o patch || { echo "âŒ KPM ä¿®è¡¥å·¥å…·ä¸‹è½½å¤±è´¥"; exit 1; }
          chmod +x patch
          echo "ğŸ”§ æ‰§è¡Œ KPM ä¿®è¡¥..."
          ./patch || { echo "âŒ KPM ä¿®è¡¥å¤±è´¥"; exit 1; }
          mv oImage Image || { echo "âŒ ä¿®è¡¥åçš„é•œåƒé‡å‘½åå¤±è´¥"; exit 1; }
          echo "âœ… KPM ä¿®è¡¥å®Œæˆ"

      - name: æ‰“åŒ… AnyKernel3
        run: |
          DEVICE="${{ github.event.inputs.target_device }}"
          KSU="${{ github.event.inputs.kernelsu_variant }}"
          SYSTEM="${{ github.event.inputs.compiled_system }}"
          BUILD_TYPE="${{ github.event.inputs.build_type }}"
          ZIP_NAME="${DEVICE}_${KSU}_${SYSTEM}_${BUILD_TYPE}_${{ github.run_id }}.zip"
          
          cd "$KERNEL_ROOT"
          echo "ğŸ“¥ å…‹éš† AnyKernel3..."
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git || { echo "âŒ AnyKernel3 å…‹éš†å¤±è´¥"; exit 1; }
          
          echo "ğŸ“ å¤åˆ¶å†…æ ¸æ–‡ä»¶..."
          cp "$KERNEL_IMAGE" AnyKernel3/ || { echo "âŒ Image å¤åˆ¶å¤±è´¥"; exit 1; }
          cp "$KERNEL_DTBO" AnyKernel3/ || { echo "âŒ DTBO å¤åˆ¶å¤±è´¥"; exit 1; }
          cp "$KERNEL_DTB" AnyKernel3/ || { echo "âŒ DTB å¤åˆ¶å¤±è´¥"; exit 1; }
          
          cd AnyKernel3
          echo "ğŸ“¦ åˆ›å»ºåˆ·æœºåŒ…..."
          zip -r9 "../$ZIP_NAME" * || { echo "âŒ åˆ·æœºåŒ…åˆ›å»ºå¤±è´¥"; exit 1; }
          echo "âœ… åˆ·æœºåŒ…åˆ›å»ºæˆåŠŸ: $ZIP_NAME"

      - name: ä¸Šä¼ ç»“æœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.target_device }}_${{ github.event.inputs.kernelsu_variant }}_${{ github.event.inputs.compiled_system }}_${{ github.event.inputs.build_type }}
          path: |
            ${{ env.KERNEL_ROOT }}/*.zip
            ${{ env.KERNEL_IMAGE }}
            ${{ env.KERNEL_DTBO }}
            ${{ env.KERNEL_DTB }}
          if-no-files-found: error
      
      - name: å‘å¸ƒ Release
        if: success()
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            ${{ env.KERNEL_ROOT }}/*.zip
            ${{ env.KERNEL_IMAGE }}
            ${{ env.KERNEL_DTBO }}
            ${{ env.KERNEL_DTB }}
          name: Kernel_${{ github.event.inputs.target_device }}_${{ github.event.inputs.kernelsu_variant }}_${{ github.event.inputs.compiled_system }}_${{ github.run_id }}
          tag_name: Kernel_${{ github.event.inputs.target_device }}_${{ github.event.inputs.kernelsu_variant }}_${{ github.event.inputs.compiled_system }}_${{ github.run_id }}
          body: |
            ----------------English----------------
            Target Device: ${{ github.event.inputs.target_device }}
            Compiled System: ${{ github.event.inputs.compiled_system }}
            KernelSU Variant: ${{ github.event.inputs.kernelsu_variant }}
            Build Type: ${{ github.event.inputs.build_type }}
            ------------------ä¸­æ–‡------------------
            ç›®æ ‡æœºå‹: ${{ github.event.inputs.target_device }}
            é€‚ç”¨ç³»ç»Ÿ: ${{ github.event.inputs.compiled_system }}
            KernelSUå˜ä½“: ${{ github.event.inputs.kernelsu_variant }}
            æ„å»ºç±»å‹: ${{ github.event.inputs.build_type }}
            ----------------------------------------
            
            ğŸ“ æ„å»ºæ—¥å¿—è¯·æŸ¥çœ‹ Actions é¡µé¢

      - name: æ¸…ç†å·¥ä½œåŒº
        if: always()
        run: |
          rm -rf "$KERNEL_ROOT"
          echo "ğŸ§¹ å·¥ä½œåŒºæ¸…ç†å®Œæˆ"
